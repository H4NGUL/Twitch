<!doctype html>
<html lang="en">
	<head>
        <title>YTPlayer for SogeBot!</title>
        <meta charset="utf-8">
        <meta name="robots" content="index, follow">
        <meta name="theme-color" content="#f4f5f6">
        <meta name="apple-mobile-web-app-status-bar-style" content="#f4f5f6">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="viewport" content="width=device-width, initial-scale=1">
	    	<!-- Google Fonts -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
        <!-- CSS Reset -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">
        <!-- Milligram CSS minified -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.1.0/milligram.min.css">
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
		<main class="wrapper">
        <div class="container" style="margin-top: 20px">
            <div class="clearfix" style="margin-bottom: 20px">
                <div id="YTPlayer" class="float-left" style="margin-right:10px"></div>
                <div>
                  <h5>Global volume - <strong id="globalVol"></strong></h5>
                </div>
            </div>
            <h4>Song requests</h4>
            <table>
                <thead>
                    <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Requested By</th>
                    <th>Length</th>
                    </tr>
                </thead>
                <tbody id="songRequests"></tbody>
            </table>

            <h4>Playlist <small class="float-right">random: <span id="randomize">n/a</span></small></h4>
            <table>
                <thead>
                    <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Length</th>
                    <th>Volume</th>
                    <th>Trim</th>
                    </tr>
                </thead>
                <tbody id="Playlist"></tbody>
            </table>
            </div>
        </main>

        <script>
            var player, time_update_interval;
            var socket = io();
            var meanLoudness = -16 // default value
            var volume = 0
            var playlist = null
            var loading = false

	          Number.isInteger = Number.isInteger || function(value) {
                return typeof value === "number" &&
                isFinite(value) &&
                    Math.floor(value) === value;
            };

            function onYouTubeIframeAPIReady() {
                player = new YT.Player('YTPlayer', {
                    width: 600,
                    height: 400,
                    videoId: '',
                    playerVars: {
                        color: 'white'
                    },
                    events: {
                        onReady: initialize,
                        onStateChange: onPlayerStateChange
                    }
                  })
            }

            function initialize(){
                socket.emit('getMeanLoudness');
                socket.emit('getVolume');
                socket.emit('getSongRequests');
                socket.emit('getPlaylist');
                socket.emit('getRandomize');
                socket.emit('getVideoID');

                // Clear any old interval.
                clearInterval(time_update_interval);

                // Start interval to update elapsed time display and
                // the elapsed part of the progress bar every second.
                time_update_interval = setInterval(function () {
                    socket.emit('getSongRequests');
                    socket.emit('getRandomize');
                    socket.emit('getMeanLoudness');
                    socket.emit('getVolume');

                    if (!loading && player.getDuration() === 0) {
                      loading = true
                      socket.emit('getVideoID');
                    }
                }, 2000)

            }

            function onPlayerStateChange (event) {
              if (event.data == YT.PlayerState.ENDED && !loading) {
                loading = true
                socket.emit('getVideoID');
              }
            }

            socket.on('videoID', function(video) {
                if (video === null) {
                  loading = false
                  player.stopVideo()
                  return
                }

                player.stopVideo()
                video.loudness = typeof video.loudness !== 'undefined' ? video.loudness : -15
                data = { 'videoId': video.videoID }
                if (typeof video.startTime !== 'undefined') data.startSeconds = video.startTime
                if (typeof video.endTime !== 'undefined') data.endSeconds = video.endTime
                player.loadVideoById(data);
                player.setVolume(getVolume(video.loudness))
                player.playVideo();
                setTimeout(function() { loading = false }, 1000)
            });

            socket.on('meanLoudness', function (loudness) {
              meanLoudness = loudness
            })

            socket.on('volume', function (vol) {
              volume = vol
              $("#globalVol").text(vol + '%')
            })

            socket.on('songRequestsList', function(list) {
                $("#songRequests").empty();
                for (var index in list) {
                    if (list.hasOwnProperty(index)) {
                        var title = list[index].title,
                            requestedBy = list[index].username,
                            length_seconds = list[index].length_seconds,
                            videoID = list[index].videoID;
                        $("#songRequests").append('<tr><td><a href="http://youtu.be/'+videoID+'">'+videoID+'</a></td><td>'+title+'</td><td>'+requestedBy+'</td><td>'+(new Date(length_seconds * 1000)).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]+'</td></tr>');
                    }
                }
            });

            socket.on('shuffle', function(isEnabled) {
              try { $("#randomize").text((isEnabled ? 'on' : 'off')); } catch (err) {}
            })

            socket.on('songPlaylistList', function(list) {
                $("#Playlist").empty();
                for (var index in list) {
                    if (list.hasOwnProperty(index)) {
                        var title = list[index].title,
                            length_seconds = list[index].length_seconds,
                            videoID = list[index].videoID,
                            loudness = typeof list[index].loudness !== 'undefined' ? list[index].loudness : -15

                        var startTime = list[index].startTime
                        var endTime = list[index].endTime
                        startTime = (typeof startTime === 'undefined' ? 0 : startTime)
                        endTime = (typeof endTime === 'undefined' ? list[index].length_seconds : endTime)

                        var lowValue = (new Date(startTime * 1000)).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]
                        var highValue = (new Date(endTime * 1000)).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]

                        $("#Playlist").append('<tr><td><a href="http://youtu.be/'+videoID+'">'+videoID+'</a></td><td>'+title+'</td><td>'+(new Date(length_seconds * 1000)).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]+'</td><td>' + getVolume(loudness) + '%</td><td><div id="slider___' + videoID + '___' + length_seconds + '"></div><div class="trim"><span class="lowValue__' + videoID + '">' + lowValue + '</span><input style="width: 4em; display: none" class="lowValueInput__' + videoID + ' type="text" value="' + lowValue + '"/> - <span class="highValue__' + videoID + '">' + highValue + '</span><input style="width: 4em; display: none" class="highValueInput__' + videoID + ' type="text" value="' + highValue + '"/></div></td></tr>');

                        makeEditable(videoID, $(".lowValue__" + videoID), $(".lowValueInput__" + videoID), endTime)
                        makeEditable(videoID, $(".highValue__" + videoID), $(".highValueInput__" + videoID), length_seconds)
                    }
                }
                playlist = list
            });

            var getVolume = function (loudness) {
                var correction = Math.ceil((volume/100) * 3)
                var loudnessDiff = parseFloat(parseFloat(meanLoudness) - loudness)
                return Math.round(volume + correction * loudnessDiff)
            }

            var makeEditable = function (id, el, input, endTime) {
              el.css('border-bottom', '1px grey dashed')
              el.on('click', function() {
                el.css('display', 'none')
                input.css('display', 'inline')
                input.focus()
              })

              input.on('focusout', function() {
                var value = input.val()
                var valueBefore = el.text()
                input.css('display', 'none')
                el.css('display', 'inline')

                /* check if value match correct pattern */
                var pattern = value.match(/^(\d\d):(\d\d):(\d\d)/)
                if (pattern !== null) {
                  var currentValue = parseInt(pattern[1], 10) * 3600 + parseInt(pattern[2], 10) * 60 + parseInt(pattern[3], 10)
                  if (currentValue > endTime) currentValue = endTime
                  var out = new Date(currentValue * 1000).toUTCString().match(/(\d\d:\d\d:\d\d)/)[0]
                  el.text(out)
                  input.val(out)

                  /* emit update */
                  var lowValuePtrn = $(".lowValue__" + id).text().match(/^(\d\d):(\d\d):(\d\d)/)
                  var lowValue = parseInt(lowValuePtrn[1], 10) * 3600 + parseInt(lowValuePtrn[2], 10) * 60 + parseInt(lowValuePtrn[3], 10)
                  var highValuePtrn = $(".highValue__" + id).text().match(/^(\d\d):(\d\d):(\d\d)/)
                  var highValue = parseInt(highValuePtrn[1], 10) * 3600 + parseInt(highValuePtrn[2], 10) * 60 + parseInt(highValuePtrn[3], 10)
                  socket.emit('setTrim', id, lowValue, highValue);
                } else {
                  input.val(valueBefore) // reset value
                }
              })
            }
        </script>

      	<!-- YTPlayer -->
        <script src="https://www.youtube.com/iframe_api"></script>
      	<script type="text/javascript" src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
        <script type="text/javascript" src="https://code.jquery.com/ui/1.12.0/jquery-ui.js"></script>
      </body>
</html>
